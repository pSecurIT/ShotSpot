name: Mobile Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - android
          - ios
          - both
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - internal
          - beta
          - production

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  # Build Android Release
  android-release:
    name: Android Release Build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            mkdir -p frontend/android/app
            echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > frontend/android/app/release.keystore
            echo "âœ… Keystore decoded successfully"
          else
            echo "âš ï¸  Warning: ANDROID_KEYSTORE_BASE64 secret not set. Skipping keystore setup."
          fi

      - name: Create keystore.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_PASSWORD" ]; then
            echo "storeFile=app/release.keystore" > frontend/android/keystore.properties
            echo "storePassword=${KEYSTORE_PASSWORD}" >> frontend/android/keystore.properties
            echo "keyAlias=${KEY_ALIAS}" >> frontend/android/keystore.properties
            echo "keyPassword=${KEY_PASSWORD}" >> frontend/android/keystore.properties
            echo "âœ… keystore.properties created"
          else
            echo "âš ï¸  Warning: Keystore secrets not set. Build may fail."
          fi

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build web app (production)
        working-directory: frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL_PRODUCTION }}
        run: npm run build

      - name: Sync Capacitor
        working-directory: frontend
        run: npx cap sync android

      - name: Make Gradlew Executable
        working-directory: frontend/android
        run: chmod +x gradlew

      - name: Bump version code
        working-directory: frontend/android
        run: |
          # Extract version from package.json and increment build number
          VERSION_NAME=$(node -p "require('../package.json').version")
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          
          # Use GitHub run number as version code
          VERSION_CODE=${{ github.run_number }}
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          
          echo "Building version $VERSION_NAME ($VERSION_CODE)"

      - name: Build Android Release AAB
        working-directory: frontend/android
        run: ./gradlew bundleRelease --stacktrace

      - name: Build Android Release APK
        working-directory: frontend/android
        run: ./gradlew assembleRelease --stacktrace

      - name: Upload AAB to Google Play
        if: |
          success() && 
          github.event_name == 'release' || 
          github.event.inputs.release_type == 'production'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.psecurit.shotspot
          releaseFiles: frontend/android/app/build/outputs/bundle/release/app-release.aab
          track: ${{ github.event.inputs.release_type || 'internal' }}
          status: completed
          whatsNewDirectory: frontend/android/release-notes

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: |
            frontend/android/app/build/outputs/bundle/release/app-release.aab
            frontend/android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      - name: Create GitHub Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            frontend/android/app/build/outputs/apk/release/app-release.apk
            frontend/android/app/build/outputs/bundle/release/app-release.aab
          token: ${{ secrets.GITHUB_TOKEN }}

  # Build iOS Release
  ios-release:
    name: iOS Release Build
    runs-on: macos-latest
    if: |
      github.event_name == 'release' || 
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install Apple Certificate
        env:
          P12_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          if [ -n "$P12_BASE64" ]; then
            echo "$P12_BASE64" | base64 --decode > certificate.p12
            security create-keychain -p "" build.keychain
            security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
            security list-keychains -s build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "" build.keychain
            security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          else
            echo "âš ï¸  Warning: iOS certificate not configured. Build may fail."
          fi

      - name: Install Provisioning Profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          if [ -n "$PROVISIONING_PROFILE_BASE64" ]; then
            PP_PATH="$HOME/Library/MobileDevice/Provisioning Profiles"
            mkdir -p "$PP_PATH"
            echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PP_PATH/profile.mobileprovision"
          else
            echo "âš ï¸  Warning: iOS provisioning profile not configured."
          fi

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build web app (production)
        working-directory: frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL_PRODUCTION }}
        run: npm run build

      - name: Sync Capacitor
        working-directory: frontend
        run: npx cap sync ios

      - name: Install iOS dependencies
        working-directory: frontend/ios/App
        run: pod install

      - name: Bump version
        working-directory: frontend/ios/App
        run: |
          VERSION_NAME=$(node -p "require('../../package.json').version")
          BUILD_NUMBER=${{ github.run_number }}
          
          # Update Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION_NAME" App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" App/Info.plist
          
          echo "Building version $VERSION_NAME ($BUILD_NUMBER)"

      - name: Build and Archive iOS app
        working-directory: frontend/ios/App
        run: |
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/App.xcarchive \
            clean archive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=${{ secrets.IOS_TEAM_ID }} \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}"

      - name: Export IPA
        working-directory: frontend/ios/App
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>uploadSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportPath build \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload to App Store Connect
        if: |
          success() && 
          github.event_name == 'release' || 
          github.event.inputs.release_type == 'production'
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          # Create API key file
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8
          
          # Upload using xcrun notarytool (altool is deprecated)
          xcrun notarytool submit frontend/ios/App/build/App.ipa \
            --key ~/private_keys/AuthKey_${APP_STORE_CONNECT_API_KEY_ID}.p8 \
            --key-id $APP_STORE_CONNECT_API_KEY_ID \
            --issuer $APP_STORE_CONNECT_ISSUER_ID \
            --wait

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: |
            frontend/ios/App/build/App.ipa
            frontend/ios/App/build/App.xcarchive
          retention-days: 30

      - name: Create GitHub Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: frontend/ios/App/build/App.ipa
          token: ${{ secrets.GITHUB_TOKEN }}

  # Notify on completion
  notify-release:
    name: Notify Release Status
    runs-on: ubuntu-latest
    needs: [android-release, ios-release]
    if: always()
    
    steps:
      - name: Release Summary
        run: |
          echo "## ðŸ“± Mobile Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Android**: ${{ needs.android-release.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS**: ${{ needs.ios-release.result || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          ANDROID_RESULT="${{ needs.android-release.result }}"
          IOS_RESULT="${{ needs.ios-release.result }}"
          
          # Check if any job ran
          if [ "$ANDROID_RESULT" = "skipped" ] && [ "$IOS_RESULT" = "skipped" ]; then
            echo "â„¹ï¸  **No releases were triggered.**" >> $GITHUB_STEP_SUMMARY
          # Check if all ran jobs succeeded
          elif ([ "$ANDROID_RESULT" = "success" ] || [ "$ANDROID_RESULT" = "skipped" ]) && \
               ([ "$IOS_RESULT" = "success" ] || [ "$IOS_RESULT" = "skipped" ]) && \
               ([ "$ANDROID_RESULT" = "success" ] || [ "$IOS_RESULT" = "success" ]); then
            echo "âœ… **All releases completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  **Some releases failed. Check logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
