name: Mobile CI

permissions:
  contents: read

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/mobile-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/mobile-ci.yml'

jobs:
  # Build and test Android app
  android-build:
    name: Android Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build web app
        working-directory: frontend
        run: npm run build

      - name: Add Android platform (robust)
        working-directory: frontend
        run: |
          set -euo pipefail
          echo "Working dir: $(pwd) — node $(node -v) npm $(npm -v)"
          
          # Validate Capacitor config exists
          if [ ! -f capacitor.config.ts ]; then
            echo "::error::Missing capacitor.config.ts file"
            exit 1
          fi
          echo "::notice::Using capacitor.config.ts"
          cat capacitor.config.ts
          
          # Validate dist directory exists
          if [ ! -d dist ]; then
            echo "::error::Web build output directory 'dist' not found"
            exit 1
          fi
          echo "::notice::Web build output 'dist' directory found"
          
          # If android dir exists, sync instead of add
          if [ -d android ]; then
            echo "::notice::android directory already exists — running 'npx cap sync android'"
            npx cap sync android || { echo "::error::npx cap sync android failed"; exit 1; }
            exit 0
          fi

          # Force reinstall @capacitor/android to ensure templates are intact
          echo "::notice::Force reinstalling @capacitor/android to fix potential corruption"
          npm install @capacitor/android --no-save --include=optional --force || { 
            echo "::error::Failed to install @capacitor/android"; 
            npm ls --depth=0 || true; 
            exit 1; 
          }

          # Try to add platform, if add fails clean up and retry once
          if npx cap add android; then
            echo "::notice::npx cap add android succeeded"
          else
            echo "::warning::npx cap add android failed — cleaning up and reinstalling"
            rm -rf android node_modules/@capacitor/android || true
            npm install @capacitor/android --no-save --include=optional --force
            echo "::notice::Retrying npx cap add android after cleanup"
            npx cap add android || {
              echo "::error::cap add failed twice. Diagnostics:"
              npm ls @capacitor/cli @capacitor/core @capacitor/android --depth=0 || true
              npx cap --version || true
              exit 1
            }
          fi

      - name: Build Android Debug APK
        working-directory: frontend/android
        run: ./gradlew assembleDebug

      - name: Upload Android APK
        uses: actions/upload-artifact@v5
        with:
          name: android-debug-apk
          path: frontend/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

      - name: Run Android Lint
        working-directory: frontend/android
        run: ./gradlew lint

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: android-lint-results
          path: frontend/android/app/build/reports/lint-results-debug.html
          retention-days: 7

  # Build and test iOS app
  ios-build:
    name: iOS Build
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build web app
        working-directory: frontend
        run: npm run build

      - name: Add iOS platform (robust)
        working-directory: frontend
        run: |
          set -euo pipefail
          echo "Working dir: $(pwd) — node $(node -v) npm $(npm -v)"
          
          # Validate Capacitor config exists
          if [ ! -f capacitor.config.ts ]; then
            echo "::error::Missing capacitor.config.ts file"
            exit 1
          fi
          echo "::notice::Using capacitor.config.ts"
          cat capacitor.config.ts
          
          # Validate dist directory exists
          if [ ! -d dist ]; then
            echo "::error::Web build output directory 'dist' not found"
            exit 1
          fi
          echo "::notice::Web build output 'dist' directory found"
          
          # If ios dir exists, sync instead of add
          if [ -d ios ]; then
            echo "::notice::ios directory exists — running 'npx cap sync ios'"
            npx cap sync ios || { echo "::error::npx cap sync ios failed"; exit 1; }
            exit 0
          fi

          # Force reinstall @capacitor/ios to ensure templates are intact
          echo "::notice::Force reinstalling @capacitor/ios to fix potential corruption"
          npm install @capacitor/ios --no-save --include=optional --force || { 
            echo "::error::Failed to install @capacitor/ios"; 
            npm ls --depth=0 || true; 
            exit 1; 
          }

          # Try to add platform, if add fails clean up and retry once
          if npx cap add ios; then
            echo "::notice::npx cap add ios succeeded"
          else
            echo "::warning::npx cap add ios failed — cleaning up and reinstalling"
            rm -rf ios node_modules/@capacitor/ios || true
            npm install @capacitor/ios --no-save --include=optional --force
            echo "::notice::Retrying npx cap add ios after cleanup"
            npx cap add ios || {
              echo "::error::cap add failed twice. Diagnostics:"
              npm ls @capacitor/cli @capacitor/core @capacitor/ios --depth=0 || true
              npx cap --version || true
              exit 1
            }
          fi

      - name: Install iOS dependencies
        working-directory: frontend/ios/App
        run: pod install

      - name: Build iOS app
        working-directory: frontend/ios/App
        run: |
          xcodebuild \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/App.xcarchive \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Archive build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ios-build
          path: frontend/ios/App/build
          retention-days: 7

  # Run mobile-specific tests
  mobile-tests:
    name: Mobile Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build web app
        working-directory: frontend
        run: npm run build

      - name: Validate Capacitor Config
        working-directory: frontend
        run: npx cap doctor

      - name: Check for Capacitor Updates
        working-directory: frontend
        run: npx cap sync

      - name: Run frontend tests
        working-directory: frontend
        run: npm test

  # Check app size
  app-size-check:
    name: App Size Check
    runs-on: ubuntu-latest
    needs: [android-build]
    
    steps:
      - name: Download Android APK
        uses: actions/download-artifact@v6
        with:
          name: android-debug-apk

      - name: Check APK size
        run: |
          APK_SIZE=$(stat -c%s "app-debug.apk")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
          echo "APK Size: $APK_SIZE_MB MB"
          
          # Fail if APK is larger than 50MB (adjust threshold as needed)
          if (( $(echo " $APK_SIZE_MB > 50" | bc -l) )); then
            echo "❌ APK size ($APK_SIZE_MB MB) exceeds 50MB threshold"
            exit 1
          else
            echo "✅ APK size ($APK_SIZE_MB MB) is within acceptable range"
          fi

  # Report status
  mobile-ci-status:
    name: Mobile CI Status
    runs-on: ubuntu-latest
    needs: [android-build, ios-build, mobile-tests, app-size-check]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.android-build.result }}" = "success" ] && \
             [ "${{ needs.ios-build.result }}" = "success" ] && \
             [ "${{ needs.mobile-tests.result }}" = "success" ] && \
             [ "${{ needs.app-size-check.result }}" = "success" ]; then
            echo "✅ All mobile CI checks passed"
            exit 0
          else
            echo "❌ Some mobile CI checks failed"
            echo "Android Build: ${{ needs.android-build.result }}"
            echo "iOS Build: ${{ needs.ios-build.result }}"
            echo "Mobile Tests: ${{ needs.mobile-tests.result }}"
            echo "App Size Check: ${{ needs.app-size-check.result }}"
            exit 1
          fi
